-- statsExtractor

-- this script extracts the monthly number of conditions, observations and drugs during the previous year
-- for each personid in the agegroup/gender for the cohort

select main.person_id,condition_1,condition_2,condition_3,condition_4,condition_5,condition_6,condition_7,condition_8,condition_9,condition_10,condition_11,condition_12,drug_1,drug_2,drug_3,drug_4,drug_5,drug_6,drug_7,drug_8,drug_9,drug_10,drug_11,drug_12,obs_1,obs_2,obs_3,obs_4,obs_5,obs_6,obs_7,obs_8,obs_9,obs_10,obs_11,obs_12 from  
(SELECT distinct a.*, b.person_id
from @database.cohort a inner join @database.person b
on a.subject_id=b.person_id
and datediff(year, datefromparts(b.year_of_birth,isnull(b.month_of_birth,1),1), cohort_start_date) between @agelower and @ageupper
and gender_concept_id=@gender
and a.cohort_definition_id =@cohortID ) main 
 left outer join  (select person_id, sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*0 and 30*1 then 1 else 0 end) [condition_1],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*1 and 30*2 then 1 else 0 end) [condition_2],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*2 and 30*3 then 1 else 0 end) [condition_3],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*3 and 30*4 then 1 else 0 end) [condition_4],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*4 and 30*5 then 1 else 0 end) [condition_5],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*5 and 30*6 then 1 else 0 end) [condition_6],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*6 and 30*7 then 1 else 0 end) [condition_7],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*7 and 30*8 then 1 else 0 end) [condition_8],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*8 and 30*9 then 1 else 0 end) [condition_9],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*9 and 30*10 then 1 else 0 end) [condition_10],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*10 and 30*11 then 1 else 0 end) [condition_11],sum(case when datediff(day, condition_era_start_date, cohort_start_date ) between 30*11 and 30*12 then 1 else 0 end) [condition_12] from   (select b.person_id, condition_concept_id, condition_era_start_date, cohort_start_date  from @outDatabase.JMR_cohort_samp a inner join @database.condition_era b  on a.subject_id=b.person_id  inner join @database.observation_period c  on a.subject_id=c.person_id   where a.cohort_definition_id=@cohortID  and datediff(day, condition_era_start_date, cohort_start_date ) between 0 and 365   and (condition_era_start_date between observation_period_start_date and observation_period_end_date       or condition_era_end_date between observation_period_start_date and observation_period_end_date)  group by b.person_id, condition_concept_id, condition_era_start_date, cohort_start_date) temp1  group by person_id) cond  on cond.person_id=main.person_id  left outer join   (select person_id, sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*0 and 30*1 then       1 else 0 end) [drug_1],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*1 and 30*2 then       1 else 0 end) [drug_2],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*2 and 30*3 then       1 else 0 end) [drug_3],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*3 and 30*4 then       1 else 0 end) [drug_4],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*4 and 30*5 then       1 else 0 end) [drug_5],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*5 and 30*6 then       1 else 0 end) [drug_6],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*6 and 30*7 then       1 else 0 end) [drug_7],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*7 and 30*8 then       1 else 0 end) [drug_8],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*8 and 30*9 then       1 else 0 end) [drug_9],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*9 and 30*10 then       1 else 0 end) [drug_10],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*10 and 30*11 then       1 else 0 end) [drug_11],sum(case when datediff(day, drug_era_start_date, cohort_start_date ) between 30*11 and 30*12 then       1 else 0 end) [drug_12] from  (select b.person_id, drug_concept_id, drug_era_start_date, cohort_start_date  from @outDatabase.JMR_cohort_samp a inner join @database.drug_era b  on a.subject_id=b.person_id  inner join @database.observation_period c  on a.subject_id=c.person_id   where a.cohort_definition_id=@cohortID  and datediff(day, drug_era_start_date, cohort_start_date ) between 0 and 365   and (drug_era_start_date between observation_period_start_date and observation_period_end_date      or drug_era_end_date between observation_period_start_date and observation_period_end_date)  group by b.person_id, drug_concept_id, drug_era_start_date, cohort_start_date) temp2  group by person_id) drug  on main.person_id=drug.person_id  left outer join  (select person_id, sum(case when datediff(day, observation_date, cohort_start_date ) between 30*0 and 30*1 then            1 else 0 end) [obs_1],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*1 and 30*2 then            1 else 0 end) [obs_2],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*2 and 30*3 then            1 else 0 end) [obs_3],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*3 and 30*4 then            1 else 0 end) [obs_4],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*4 and 30*5 then            1 else 0 end) [obs_5],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*5 and 30*6 then            1 else 0 end) [obs_6],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*6 and 30*7 then            1 else 0 end) [obs_7],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*7 and 30*8 then            1 else 0 end) [obs_8],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*8 and 30*9 then            1 else 0 end) [obs_9],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*9 and 30*10 then            1 else 0 end) [obs_10],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*10 and 30*11 then            1 else 0 end) [obs_11],sum(case when datediff(day, observation_date, cohort_start_date ) between 30*11 and 30*12 then            1 else 0 end) [obs_12]from( select b.person_id, observation_concept_id, observation_date, cohort_start_date                from @outDatabase.JMR_cohort_samp a inner join @database.observation b  on a.subject_id=b.person_id and a.cohort_definition_id=@cohortID  inner join @database.observation_period c  on a.subject_id=c.person_id   where datediff(day, observation_date, cohort_start_date ) between 0 and 365  and (observation_date between observation_period_start_date and observation_period_end_date  or observation_date between observation_period_start_date and observation_period_end_date)  group by b.person_id, observation_concept_id, observation_date, cohort_start_date) temp3  group by person_id ) obs  on obs.person_id=main.person_id

